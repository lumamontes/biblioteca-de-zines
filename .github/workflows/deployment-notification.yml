name: Deployment Notification

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

jobs:
  notify-deployment:
    runs-on: ubuntu-latest
    name: Notify Telegram on Deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Wait for Vercel deployment
        run: |
          echo "Waiting for Vercel to complete deployment..."
          sleep 30 # Wait 30 seconds for Vercel to start deployment
      
      - name: Get deployment info
        id: deployment
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          DEPLOYMENT_URL="https://www.biblioteca-de-zines.com.br"
          
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
      
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram credentials not configured. Skipping notification."
            exit 0
          fi
          
          URL="${{ steps.deployment.outputs.url }}"
          COMMIT_MSG="${{ steps.deployment.outputs.message }}"
          COMMIT_AUTHOR="${{ steps.deployment.outputs.author }}"
          COMMIT_SHA="${{ steps.deployment.outputs.sha }}"
          
          # Build JSON payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg chat_id "$TELEGRAM_CHAT_ID" \
            --arg url "$URL" \
            --arg commit_msg "$COMMIT_MSG" \
            --arg commit_author "$COMMIT_AUTHOR" \
            --arg commit_sha "$COMMIT_SHA" \
            --arg topic_id "$TELEGRAM_TOPIC_ID" \
            '{
              chat_id: $chat_id,
              text: "✅ <b>Deploy Sucesso</b>\n\n<b>URL:</b> <a href=\"\($url)\">\($url)</a>\n<b>Commit:</b> \($commit_msg)\n<b>Autor:</b> \($commit_author)\n",
              parse_mode: "HTML"
            } + (if $topic_id != "" then {message_thread_id: ($topic_id | tonumber)} else {} end)')
          
          # Send notification
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ] && echo "$BODY" | jq -e '.ok == true' > /dev/null 2>&1; then
            echo "✅ Telegram notification sent successfully"
          else
            echo "❌ Failed to send Telegram notification"
            echo "Response: $BODY"
            echo "HTTP Code: $HTTP_CODE"
            exit 1
          fi

